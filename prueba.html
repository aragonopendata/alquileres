<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://openlayers.org/en/v3.20.1/css/ol.css"
      type="text/css"
    />
    <script
      src="https://openlayers.org/en/v3.20.1/build/ol.js"
      type="text/javascript"
    ></script>
    <title>AOD - Fianzas</title>

    <style>
      .map {
        width: 100%;
        height: 100%;
      }
      .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after,
      .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "✖";
      }
    </style>
  </head>

  <body>
    <h1>Demo Fianzas</h1>
    <div id="map" class="map"></div>

    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>

    <script type="text/javascript">
      "use strict";

              // Popup

              var container = document.getElementById('popup');
        var content = document.getElementById('popup-content');
        var closer = document.getElementById('popup-closer');

        var overlay = new ol.Overlay({
          element: container,
          autoPan: true,
          autoPanAnimation: {
            duration: 250,
          },
        });

      let xmlToJson = (xml) => {
        let obj = {};
        if (xml.nodeType == 1) {
          if (xml.attributes.length > 0) {
            obj["@attributes"] = {};
            for (let j = 0; j < xml.attributes.length; j++) {
              let attribute = xml.attributes.item(j);
              obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
            }
          }
        } else if (xml.nodeType == 3) {
          obj = xml.nodeValue;
        }
        if (xml.hasChildNodes()) {
          for (let i = 0; i < xml.childNodes.length; i++) {
            let item = xml.childNodes.item(i);
            let nodeName = item.nodeName;
            if (typeof obj[nodeName] == "undefined") {
              obj[nodeName] = xmlToJson(item);
            } else {
              if (typeof obj[nodeName].push == "undefined") {
                let old = obj[nodeName];
                obj[nodeName] = [];
                obj[nodeName].push(old);
              }
              obj[nodeName].push(xmlToJson(item));
            }
          }
        }
        return obj;
      };

      let getObjectID = (cp) => {
        let objectID = null;
        const url = new URL(
          "https://cors-anywhere.herokuapp.com/https://idearagon.aragon.es/SimpleSearchService/typedSearchService"
        );
        const params = new URLSearchParams();
        params.set("texto", cp);
        params.set("type", "v111_codigo_postal");
        params.set("app", "DV");
        url.search = params.toString();
        let xhr = new XMLHttpRequest();
        xhr.open("GET", url.toString(), false);
        xhr.send();
        if (xhr.status == 200) {
          let data = xmlToJson(xhr.responseXML);
          console.log(data);
          let response =
            data["SOAP-ENV:Envelope"]["SOAP-ENV:Body"].SearchResponse
              .SearchResult.List["#text"];
          objectID = response.split("#")[3];
        }
        return objectID;
      };

      let getCQLFilter = (objectID, capa, distancia) => {
        let cqlFilter = `objectid=${objectID}`;
        const url = new URL(
          "https://cors-anywhere.herokuapp.com/https://idearagon.aragon.es/SpatialSearchService/services"
        );
        const params = new URLSearchParams();
        params.set("SERVICE", "DV");
        params.set("TYPENAME", "carto.v111_codigo_postal");
        params.set("CQL_FILTER", `OBJECTID=${objectID}`);
        params.set("PROPERTYNAME", "OBJECTID");
        params.set("TYPENAME_CONN", "DV");
        let xhr = new XMLHttpRequest();
        xhr.open("POST", url.toString(), false);
        xhr.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded"
        );
        xhr.send(params.toString());
        if (xhr.status == 200) {
          let data = JSON.parse(xhr.responseText);
          console.log(data);
          for (let resultado of data.resultados) {
            if (
              resultado.distancia === distancia &&
              resultado.capa.includes(capa)
            ) {
              for (let feature of resultado.featureCollection.features) {
                // cqlFilter += cqlFilter !== '' ? ' OR ' : '';
                cqlFilter += ` OR objectid=${feature.properties.objectid}`;
              }
              break;
            }
          }
        }
        return cqlFilter;
      };

      let getWFS = (endpoint, capa, wms_srs, cqlFilter) => {
        let data = null;
        const url = new URL(endpoint);
        const params = new URLSearchParams();
        params.set("service", "WFS");
        params.set("version", "1.0.0");
        params.set("request", "GetFeature");
        params.set("typename", capa);
        params.set("outputFormat", "application/json");
        params.set("srsname", wms_srs);
        params.set("CQL_FILTER", cqlFilter);
        let xhr = new XMLHttpRequest();
        xhr.open("POST", url.toString(), false);
        xhr.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded"
        );
        xhr.send(params.toString());
        if (xhr.status == 200) {
          data = JSON.parse(xhr.responseText);
          console.log(data);
        }
        return data;
      };

      let getBBox = (features) => {
        let bbox = [Infinity, Infinity, -Infinity, -Infinity];
        for (let feature of features) {
          if (feature.geometry.type == "Polygon") {
            for (let row of feature.geometry.coordinates) {
              for (let coordinate of row) {
                bbox[0] = coordinate[0] < bbox[0] ? coordinate[0] | 0 : bbox[0];
                bbox[2] = coordinate[0] > bbox[2] ? coordinate[0] | 0 : bbox[2];
                bbox[1] = coordinate[1] < bbox[1] ? coordinate[1] | 0 : bbox[1];
                bbox[3] = coordinate[1] > bbox[3] ? coordinate[1] | 0 : bbox[3];
              }
            }
          }
        }
        return bbox;
      };

      let WMS_SRS = "EPSG:25830";
      let map_projection = new ol.proj.Projection({
        code: WMS_SRS,
        units: "m",
      });
      let options = {
        projection: map_projection,
      };
      let map = new ol.Map({
        target: "map",
        view: new ol.View(options),
        overlays: [overlay],
      });

      let layerAragon = new ol.layer.Tile({
        source: new ol.source.TileWMS({
          url:
            "https://idearagon.aragon.es/arcgis/services/AragonReferencia/Basico_NEW/MapServer/WMSServer",
          params: {
            LAYERS: "0,2,4,5,6,8,9,10,11,12,13,14,15,16,17,18,19",
            VERSION: "1.1.1",
          },
          projection: map_projection,
        }),
      });
      map.addLayer(layerAragon);

      let layerFianzas = new ol.layer.Tile({
        source: new ol.source.TileWMS({
          url: "https://idearagon.aragon.es/SITA_WMS",
          params: {
            LAYERS: "fianzas",
            VERSION: "1.0.0",
          },
          projection: map_projection,
        }),
      });
      // map.addLayer(layerFianzas);

      let objectID = getObjectID("50001");
      let cqlFilter = getCQLFilter(objectID, "fianzas", 1000);
      let fianzasWfs = getWFS(
        "https://cors-anywhere.herokuapp.com/https://idearagon.aragon.es/SITA_WMS",
        "fianzas",
        WMS_SRS,
        cqlFilter
      );
      let cpWfs = getWFS(
        "https://cors-anywhere.herokuapp.com/https://idearagon.aragon.es/Visor2D",
        "v111_codigo_postal",
        WMS_SRS,
        `objectid=${objectID}`
      );
      let bbox = getBBox(cpWfs.features);

      let geojsonFormat = new ol.format.GeoJSON();
      let features = geojsonFormat.readFeatures(JSON.stringify(fianzasWfs));

      let vector = new ol.layer.Vector({
        source: new ol.source.Vector({
          format: geojsonFormat,
          features: features,
        }),
        features: geojsonFormat.readFeatures(JSON.stringify(fianzasWfs)),
      });

      map.addLayer(vector);

      let onFeatureSelectFuncion = (evt) => {
        let feature = evt.element;
        let info = {
          via_loc: feature.get("via_loc"),
          anyo: 0,
          vivienda_min: 0,
          vivienda_max: 0,
          vivienda_media: 0,
          local_min: 0,
          local_max: 0,
          local_media: 0,
        };
        for (let valor of JSON.parse(feature.get("valores"))) {
          if (valor.anyo >= info.anyo && valor.tipo === 1) {
            info.anyo = valor.anyo;
            info.vivienda_min = valor.min;
            info.vivienda_max = valor.max;
            info.vivienda_media = valor.media;
          } else if (valor.anyo >= info.anyo && valor.tipo === 2) {
            info.anyo = valor.anyo;
            info.local_min = valor.min;
            info.local_max = valor.max;
            info.local_media = valor.media;
          }
        }
        var coordinate = evt.coordinate;
            var hdms = ol.coordinate.toStringHDMS(ol.proj.toLonLat(coordinate));
            var contenidoPopup = `
            <p>${info.via_loc}</p>
            <p>Viviendas 
              <ul>
                <li>Media: ${info.vivienda_media}</li>
                <li>Máx.: ${info.vivienda_max}</li>
                <li>Mín.: ${info.vivienda_min}</li>
              </ul>
            </p>
            <p>Locales 
              <ul>
                <li>Media: ${info.local_media}</li>
                <li>Máx.: ${info.local_max}</li>
                <li>Mín.: ${info.local_min}</li>
              </ul>
            </p>
            <p>Datos de ${info.anyo}</p>`;

            content.innerHTML = contenidoPopup
            overlay.setPosition(coordinate);
        
            console.log(info);
      };

      map.on("pointermove", (evt) => {
        var pixel = map.getEventPixel(evt.originalEvent);
        map.forEachFeatureAtPixel(pixel, function (feature, resolution) {
          evt.element = feature;
          onFeatureSelectFuncion(evt);
        });
      });

      map.getView().fit(bbox, map.getSize());
    </script>
  </body>
</html>
